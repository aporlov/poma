# poma
**Po**stgresql projects **Ma**kefile

## Usage

* `make config` - создать файл настроек (.env)
* `make create[-default]` - первичное создание пакета
* `make build[-default]` - сборка хранимого кода
* `make test[-default]` - запуск тестов
* `make recreate[-default]` - пересоздание пакетов со сборкой кода
* `make drop[-default]` - удаление пакета
* `make erase[-default]` - удаление пакета и его персистентных данных

## SQL filename

Файлы в пакетах имеют формат MM_описание[_once].sql, где

тип MM имеет значения:

* 00 - drop/erase: удаление связей текущей схемы с другими схемами
* 01 - erase: удаление защищенных объектов из других схем (wsd)
* 02 - drop/erase: удаление текущей схемы (02_drop)
* 10 - init: инициализация до создания схемы
* 11 - init: создание схемы, после выполнения 11* имя схемы из имени каталога добавится в путь поиска
* 12 - init: зависимости от других пакетов, создание доменов и типов
* 1[4-9] - общие файлы для init и make, код, не имеющий зависимостей от объектов, может использоваться при создании таблиц
* 2x - создание таблиц
* 3x - ф-и для представлений
* 4x - представления
* 5x - основной код функций
* 6x - код триггеров
* 7x - создание триггеров
* 8x - наполнение таблиц
* 9x - тесты

Если файл имеет суффикс `_once`, то он будет выполнен однократно.

## препроцессинг

* (1|3|5|6)*.sql - замена `/($_$)($| +#?)/` на `\1\2 /* FILENAME:FILELINE */`
* 9*.sql - замена `/ -- BOT/` и `/; -- EOT/` на код поддержки тестов

## алгоритм

```
процесс для каждого пакета
  получить список файлов процесса
  обработать файлы с ф-ями
  обработать тесты
  сгенерить инклюд с контролем персов через БД

общий процесс

получить список пакетов
если recreate
    процесс drop для каждого пакета в обратном порядке
    процесс create для каждого пакета
    собрать инклюды в build.sql
иначе
    процесс для каждого пакета
    собрать инклюды в build.sql
запустить build.sql
```

## Примеры
```
make clean poma-build POMA_PKG=
make clean poma-build POMA_PKG=sample
```

## TODO

* [ ] переехать в pomasql/poma
* [ ] creatif
* [ ] доработать log()
* [ ] в deps проверять psql
* [ ] поддержка make v3.81
* [ ] psql в docker
* [ ] если awk ничего не моменял - вызвать исходник из sql/

## License

The MIT License (MIT), see [LICENSE](LICENSE).

Copyright (c) 2018 Aleksei Kovrizhkin <lekovr+poma@gmail.com>
